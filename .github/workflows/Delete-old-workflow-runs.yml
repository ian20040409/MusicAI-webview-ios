

name: Manual cleanup (keep newest N runs)

on:
  workflow_dispatch:
    inputs:
      keep:
        description: 'è¦ä¿ç•™çš„æœ€æ–° run ç­†æ•¸ (ä¾‹å¦‚ 3)'
        required: true
        default: '1'

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_REPO: ${{ github.repository }}
    steps:
      - name: Delete all runs except the newest N
        run: |
          KEEP=${{ github.event.inputs.keep }}
          echo "ğŸ”¹ Repository: $GH_REPO"
          echo "ğŸ”¹ ä¿ç•™æœ€æ–° $KEEP ç­†ï¼Œåˆªé™¤å…¶é¤˜çš„ workflow runs"

          # å–å¾—æ‰€æœ‰ run IDsï¼ˆç”±æ–°åˆ°èˆŠæ’åºï¼‰
          ids=$(gh run list --repo "$GH_REPO" --limit 1000 \
            --json databaseId,createdAt \
            --jq "sort_by(.createdAt) | reverse | .[${KEEP}:] | .[].databaseId")

          if [ -z "$ids" ]; then
            echo "âœ… æ²’æœ‰éœ€è¦åˆªé™¤çš„èˆŠ runs"
            exit 0
          fi

          echo "ğŸ—‘ï¸ å…±æœ‰ $(echo $ids | wc -w) ç­†èˆŠ runs å°‡è¢«åˆªé™¤..."
          for id in $ids; do
            gh run delete "$id" --repo "$GH_REPO"
          done

          echo "âœ… æ¸…ç†å®Œæˆï¼Œåªä¿ç•™æœ€æ–° $KEEP ç­† runsã€‚"



