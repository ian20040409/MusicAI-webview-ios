
name: Manual cleanup (keep only newest run)

on:
  workflow_dispatch:   # æ‰‹å‹•è§¸ç™¼

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Delete all runs except the newest (repo-wide)
        run: |
          echo "Fetching all workflow runs..."
          ids=$(gh run list --limit 1000 \
            --json databaseId,createdAt \
            --jq 'sort_by(.createdAt) | reverse | .[1:] | .[].databaseId')

          if [ -z "$ids" ]; then
            echo "âœ… No old runs to delete!"
            exit 0
          fi

          echo "Deleting old workflow runs..."
          for id in $ids; do
            gh run delete "$id"
          done
          echo "ðŸ§¹ Cleanup complete â€” only the newest run remains."
